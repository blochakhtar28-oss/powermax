  <!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PowerMax Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box;font-family:"Segoe UI",Arial,sans-serif;margin:0;padding:0}
body{background:linear-gradient(180deg,#eef3f9,#f9fbfd);display:flex;justify-content:center;padding:20px;color:#1f2d3d}
.container{width:100%;max-width:420px}
.header{text-align:center;font-size:24px;font-weight:700;margin-bottom:14px;color:#0a66ff}

.user-box{background:#fff;border-radius:14px;padding:14px;text-align:center;box-shadow:0 8px 20px rgba(0,0,0,.06);margin-bottom:18px;font-size:14px}
.user-box div{margin:4px 0}

.plan{display:flex;justify-content:space-between;align-items:center;padding:14px;border-radius:14px;margin-bottom:12px;box-shadow:0 6px 16px rgba(0,0,0,.06)}
.plan small{display:block;font-size:12px;opacity:.8}
.plan button{padding:8px 16px;border:none;border-radius:22px;cursor:pointer;font-weight:600}
.btn-active{background:#e8eef6}
.btn-on{background:#00c853;color:#fff}

.p50 div, .p50 div small { color: #ffffff; }      /* Text on Green */
.p100 div, .p100 div small { color: #1a1a1a; }   /* Text on Yellow */
.p300 div, .p300 div small { color: #ffffff; }    /* Text on Purple */
.p500 div, .p500 div small { color: #ffffff; }    /* Text on Blue */
.p1000 div, .p1000 div small { color: #ffffff; }  /* Text on Lavender */
.p2000 div, .p2000 div small { color: #ffffff; }  /* Text on Pink */
.p3000 div, .p3000 div small { color: #ffffff; }  /* Text on Mint */
.p5000 div, .p5000 div small { color: #ffffff; }  /* Text on Gray */

.active-box{display:none;background:#fff;border-radius:14px;padding:14px;margin-top:14px;box-shadow:0 6px 16px rgba(0,0,0,.08);font-size:14px}
.active-box h3{text-align:center;margin-bottom:10px;color:#0a66ff}

.actions{margin-top:18px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
.actions button{padding:12px;border:none;border-radius:26px;font-weight:600;color:#fff;cursor:pointer}
.refer{background:#6a11cb}
.deposit{background:#11998e}
.withdraw{background:#ff512f}
.support{background:#25d366}

.logout{margin-top:18px;width:100%;padding:12px;border:none;border-radius:26px;background:#ff4b2b;color:#fff;font-weight:600;cursor:pointer}

/* POPUP */
.popup{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);justify-content:center;align-items:center;z-index:1000}
.popup-box{background:#fff;width:90%;max-width:400px;border-radius:20px;padding:18px}
.popup-box h3{text-align:center}
.popup-box small{text-align:center;display:block;color:#777;margin-bottom:10px}
.popup-box label{font-size:13px;font-weight:600;margin-top:10px;display:block}
.popup-box input,.popup-box select{width:100%;padding:10px;margin-top:6px;border-radius:10px;border:1px solid #ccc}
.popup-actions{display:flex;gap:10px;margin-top:16px}
.confirm{flex:1;background:#ff512f;color:#fff;border:none;padding:12px;border-radius:25px}
.cancel{flex:1;background:#eee;border:none;padding:12px;border-radius:25px}
</style>
</head>

<body>
<div class="container">

<div class="header">‚ö° PowerMax Dashboard ‚ö°</div>

<div class="user-box">
  <div><b>User ID:</b> <span id="userId">Loading...</span></div>
  <div><b>Balance:</b> <span id="userBalance">0</span> PTS</div>
  <div id="useremail">Loading...</div>
</div>

<!-- ALL PTS PLANTS -->
<div class="plan p50"><div>50 PTS Plant <small>Commission 40%</small></div><button class="btn-active" onclick="activatePlan('50 PTS',40,this)">Activate</button></div>
<div class="plan p100"><div>100 PTS Plant <small>Commission 45%</small></div><button class="btn-active" onclick="activatePlan('100 PTS',45,this)">Activate</button></div>
<div class="plan p300"><div>300 PTS Plant <small>Commission 50%</small></div><button class="btn-active" onclick="activatePlan('300 PTS',50,this)">Activate</button></div>
<div class="plan p500"><div>500 PTS Plant <small>Commission 60%</small></div><button class="btn-active" onclick="activatePlan('500 PTS',60,this)">Activate</button></div>
<div class="plan p1000"><div>1000 PTS Plant <small>Commission 60%</small></div><button class="btn-active" onclick="activatePlan('1000 PTS',60,this)">Activate</button></div>
<div class="plan p2000"><div>2000 PTS Plant <small>Commission 60%</small></div><button class="btn-active" onclick="activatePlan('2000 PTS',60,this)">Activate</button></div>
<div class="plan p3000"><div>3000 PTS Plant <small>Commission 60%</small></div><button class="btn-active" onclick="activatePlan('3000 PTS',60,this)">Activate</button></div>
<div class="plan p5000"><div>5000 PTS Plant <small>Commission 60%</small></div><button class="btn-active" onclick="activatePlan('5000 PTS',60,this)">Activate</button></div>

<div class="active-box" id="activeBox"></div>

<div class="actions">
  <button class="refer" onclick="openRefer()">Refer & Earn</button>
  <button class="deposit" onclick="openDeposit()">Deposit</button>
  <button class="withdraw" onclick="openWithdraw()">Withdraw</button>
  <button class="support" onclick="openWhatsAppSupport()">
  WhatsApp Support
</button>
</div>

<button class="logout" onclick="logout()">Logout</button>
</div>
<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getAuth,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

import {
  getFirestore,
  doc,
  setDoc,
  getDoc,
  updateDoc,
  increment,
  collection,
  query,
  where,
  getDocs,
  addDoc   // üëà ADD THIS
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCzHxyLgn9ZKRwD1X0RuUSq3od6MWizieg",
  authDomain: "powermax-fe149.firebaseapp.com",
  projectId: "powermax-fe149"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
// üîß LOAD GLOBAL SETTINGS
async function loadGlobalSettings() {
  const ref = doc(db, "settings", "global");
  const snap = await getDoc(ref);

  if (!snap.exists()) {
    console.error("‚ùå Global settings not found");
    return null;
  }

  return snap.data();
}
const activeBox = document.getElementById("activeBox");
// üîí ADMIN CHECK FUNCTION
async function isAdmin(uid) {
  const adminRef = doc(db, "admins", uid);
  const adminSnap = await getDoc(adminRef);

  if (!adminSnap.exists()) {
    return false;
  }

  return adminSnap.data().role === "admin";
}
// üîπ Save user in Firestore
function generateRefCode() {
  return "PMX" + Math.random().toString(36).substring(2,8).toUpperCase();
}
function getReferralCodeFromURL() {
  const params = new URLSearchParams(window.location.search);
  return params.get("ref"); // null if not exists
}

async function saveUser(u) {
  const ref = doc(db, "users", u.uid);
  const snap = await getDoc(ref);

  if (!snap.exists()) {
    const referredBy = getReferralCodeFromURL();

await setDoc(ref, {
  email: u.email,
  balance: 0,
  refCode: generateRefCode(),
  referredBy: referredBy || null,
  createdAt: new Date().toISOString()
});
  }
}

/* üîê USER CHECK */
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    location.href = "index.html";
    return;
  }

  // üîπ email show
  document.getElementById("useremail").innerText = user.email;

  // üîπ pehle ensure user saved ho
  await saveUser(user);
  // üîê ADMIN CHECK (STEP 2)
const admin = await isAdmin(user.uid);

if (admin) {
  console.log("‚úÖ Admin logged in:", user.email);
  // future: admin panel access
} else {
  console.log("üë§ Normal user:", user.email);
}
// üîí Global admin flag
window.IS_ADMIN = admin;

  // üîπ ab Firestore se real data load
  const userRef = doc(db, "users", user.uid);
  const snap = await getDoc(userRef);

  if (snap.exists()) {
    document.getElementById("userBalance").innerText =
      snap.data().balance ?? 0;

    document.getElementById("userId").innerText =
      snap.data().refCode ?? "NO REF";
      const plantRef = doc(db, "users", user.uid, "plants", "active");
  const plantSnap = await getDoc(plantRef);

  if (plantSnap.exists()) {
    const p = plantSnap.data();

    activeBox.style.display = "block";
    activeBox.innerHTML = `
      <h3>Active PTS Plant Details</h3>
      <b>Plan:</b> ${p.planName}<br>
      <b>Commission:</b> ${p.commission}%<br><br>
      <b>Activated:</b><br>${new Date(p.activatedAt).toLocaleString()}<br><br>
      <b>Expiry:</b><br>${new Date(p.expiryAt).toLocaleString()}
    `;
    // üîí Keep active plan button GREEN permanently until expiry
    document.querySelectorAll(".plan").forEach(planDiv => {
      if (planDiv.innerText.includes(p.planName)) {
        const btn = planDiv.querySelector("button");
        btn.classList.remove("btn-active");
        btn.classList.add("btn-on");
      }
    });
  }
  }
});



window.openWhatsAppSupport = () => {
  const user = auth.currentUser;

  if (!user) {
    alert("User not logged in");
    return;
  }

  const name = user.email; 
const uid = document.getElementById("userId").innerText;
  const balance = document.getElementById("userBalance").innerText;

  const message = `Hello PowerMax Support, I need assistance.

*Account Details:*
Name: ${name}
UID: ${uid}
Balance: ${balance} pts

My Query is: `;

  const phone = "923008775258"; // ÿßŸæŸÜÿß WhatsApp number
  const url = "https://wa.me/" + phone + "?text=" + encodeURIComponent(message);

  window.open(url, "_blank");
};
window.logout=()=>signOut(auth).then(()=>location.href="index.html");
window.activatePlan = async (planName, commission, btn) => {
  const user = auth.currentUser;
  if (!user) {
    alert("User not logged in");
    return;
  }

  const plantRef = doc(db, "users", user.uid, "plants", "active");

  // üîí Duplicate check
  const existingPlantSnap = await getDoc(plantRef);
  if (existingPlantSnap.exists()) {
    const data = existingPlantSnap.data();
    if (new Date(data.expiryAt) > new Date()) {
      alert("Plant already active. Wait until expiry.");
      return;
    }
  }

  const start = new Date();
  const expiry = new Date();
  // üîß get expiry days from admin settings
const settings = await loadGlobalSettings();
const days = settings.planExpiryDays || 30;

expiry.setDate(start.getDate() + days);
  // üîí LOW BALANCE CHECK
const plantPts = parseInt(planName.split(" ")[0]);

const balanceSnap = await getDoc(doc(db, "users", user.uid));
const balance = balanceSnap.data().balance || 0;

if (balance < plantPts) {
  alert("Low Balance");
  return;
}
// üí∏ CUT USER BALANCE
await updateDoc(doc(db, "users", user.uid), {
  balance: increment(-plantPts)
});

  // ‚úÖ Save plant
  await setDoc(plantRef, {
    planName,
    commission,
    activatedAt: start.toISOString(),
    expiryAt: expiry.toISOString()
  });

  // üî• COMMISSION LOGIC (FINAL ‚Äî AS PER RULES)


/* =========================
   1Ô∏è‚É£ DIRECT COMMISSION (30%)
   ONLY FOR THE USER
========================= */

const DIRECT_COMMISSION = 30;
const selfCommission = plantPts * (DIRECT_COMMISSION / 100);

await updateDoc(doc(db, "users", user.uid), {
  balance: increment(selfCommission)
});

/* =========================
   2Ô∏è‚É£ REFERRAL COMMISSION
   BASED ON REFERRER PLAN
========================= */

const userRef = doc(db, "users", user.uid);
const userSnap = await getDoc(userRef);

if (userSnap.exists()) {
  const referredBy = userSnap.data().referredBy;

  if (referredBy) {
    const q = query(
      collection(db, "users"),
      where("refCode", "==", referredBy)
    );

    const qsnap = await getDocs(q);

    for (const refDoc of qsnap.docs) {
      // referrer commission = based on HIS active plan
      const refCommission = plantPts * (commission / 100);

      await updateDoc(doc(db, "users", refDoc.id), {
        balance: increment(refCommission)
      });
    }
  }
}

  // üîÑ UI update
  document.querySelectorAll(".plan button").forEach(b => {
    b.className = "btn-active";
    b.innerText = "Activate";
  });

  btn.className = "btn-on";
  btn.innerText = "Activated";

  activeBox.style.display = "block";
  activeBox.innerHTML = `
    <h3>Active PTS Plant Details</h3>
    <b>Plan:</b> ${planName}<br>
    <b>Commission:</b> ${commission}%<br><br>
    <b>Activated:</b><br>${start.toLocaleString()}<br><br>
        <b>Expiry:</b><br>${expiry.toLocaleString()}
  `;
};

</script>

</body>
</html>
