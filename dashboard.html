   <!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PowerMax Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box;font-family:"Segoe UI",Arial,sans-serif;margin:0;padding:0}
body{background:linear-gradient(180deg,#eef3f9,#f9fbfd);display:flex;justify-content:center;padding:20px;color:#1f2d3d}
.container{width:100%;max-width:420px}
.header{text-align:center;font-size:24px;font-weight:700;margin-bottom:14px;color:#0a66ff}

.user-box{background:#fff;border-radius:14px;padding:14px;text-align:center;box-shadow:0 8px 20px rgba(0,0,0,.06);margin-bottom:18px;font-size:14px}
.user-box div{margin:4px 0}

.plan{display:flex;justify-content:space-between;align-items:center;padding:14px;border-radius:14px;margin-bottom:12px;box-shadow:0 6px 16px rgba(0,0,0,.06)}
.plan small{display:block;font-size:12px;opacity:.8}
.plan button{padding:8px 16px;border:none;border-radius:22px;cursor:pointer;font-weight:600}
.btn-active{background:#e8eef6}
.btn-on{background:#00c853;color:#fff}

.p50 div, .p50 div small { color: #e6f4ea; }      /* Text on Green background */
.p100 div, .p100 div small { color: #fff9db; }    /* Text on Yellow background */
.p300 div, .p300 div small { color: #e9d7ff; }    /* Text on Purple background */
.p500 div, .p500 div small { color: #d0f0ff; }    /* Text on Blue background */
.p1000 div, .p1000 div small { color: #e3d7ff; }  /* Text on Lavender background */
.p2000 div, .p2000 div small { color: #ffd6e0; }  /* Text on Pink background */
.p3000 div, .p3000 div small { color: #c3f4f0; }  /* Text on Mint background */
.p5000 div, .p5000 div small { color: #d9dce2; }  /* Text on Gray background */
/* ===== HISTORY / REFER COMMON POPUP UI ===== */
.history-box{
  background:#fff;
  width:90%;
  max-width:360px;
  border-radius:18px;
  padding:16px;
}
.history-box h3{
  text-align:center;
  color:#0a66ff;
  margin-bottom:8px;
}
.history-item{
  background:#f1f5f9;
  border-radius:12px;
  padding:10px;
  font-size:13px;
  margin-bottom:8px;
}
.history-status-pending{color:#ca8a04;font-weight:700}
.history-status-approved{color:#16a34a;font-weight:700}
.history-status-cancel{color:#dc2626;font-weight:700}
.close-btn{
  margin-top:10px;
  width:100%;
  padding:10px;
  border:none;
  border-radius:22px;
  background:#eee;
  font-weight:600;
}

.active-box{display:none;background:#fff;border-radius:14px;padding:14px;margin-top:14px;box-shadow:0 6px 16px rgba(0,0,0,.08);font-size:14px}
.active-box h3{text-align:center;margin-bottom:10px;color:#0a66ff}

.actions{margin-top:18px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
.actions button{padding:12px;border:none;border-radius:26px;font-weight:600;color:#fff;cursor:pointer}
.refer{background:#6a11cb}
.deposit{background:#11998e}
.withdraw{background:#ff512f}
.support{background:#25d366}

.logout{margin-top:18px;width:100%;padding:12px;border:none;border-radius:26px;background:#ff4b2b;color:#fff;font-weight:600;cursor:pointer}

/* POPUP */
.popup{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);justify-content:center;align-items:center;z-index:1000}
.popup-box{background:#fff;width:90%;max-width:400px;border-radius:20px;padding:18px}
.popup-box h3{text-align:center}
.popup-box small{text-align:center;display:block;color:#777;margin-bottom:10px}
.popup-box label{font-size:13px;font-weight:600;margin-top:10px;display:block}
.popup-box input,.popup-box select{width:100%;padding:10px;margin-top:6px;border-radius:10px;border:1px solid #ccc}
.popup-actions{display:flex;gap:10px;margin-top:16px}
.confirm{flex:1;background:#ff512f;color:#fff;border:none;padding:12px;border-radius:25px}
.cancel{flex:1;background:#eee;border:none;padding:12px;border-radius:25px}
/* ===== REFERRAL MODAL ===== */
.ref-modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.6);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:999;
}
.ref-box{
  background:#fff;
  width:92%;
  max-width:380px;
  border-radius:18px;
  padding:20px;
  color:#020617;
}
.ref-title{font-size:18px;font-weight:800;color:#2563eb}
.ref-sub{font-size:13px;margin:6px 0 12px;color:#475569}
.ref-label{font-size:13px;font-weight:700}
.ref-link{display:flex;gap:8px;margin:8px 0 14px}
.ref-link input{
  flex:1;
  padding:8px;
  border-radius:10px;
  border:1px solid #cbd5f5;
}
.copy-btn{
  background:#22c55e;
  border:none;
  color:#fff;
  padding:8px 14px;
  border-radius:10px;
  font-weight:700;
}
.level{margin-top:12px;font-size:14px}
.l1{color:#16a34a}
.l2{color:#dc2626}
.level-box{
  background:#ecfdf5;
  border-radius:12px;
  padding:14px;
  text-align:center;
  font-size:13px;
  margin-top:6px;
}
.close-ref{
  margin-top:16px;
  width:100%;
  padding:12px;
  border-radius:14px;
  border:2px solid #64748b;
  background:#fff;
  font-weight:700;
}
/* ===== DEPOSIT MODAL ===== */
.dep-modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.6);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:999;
}

.dep-box{
  background:#ffffff;
  width:92%;
  max-width:380px;
  border-radius:18px;
  padding:20px;
  color:#020617;
}

.dep-title{
  font-size:18px;
  font-weight:800;
  color:#2563eb;
  margin-bottom:10px;
}

.dep-field{
  margin-bottom:12px;
}

.dep-field label{
  font-size:13px;
  font-weight:700;
}

.dep-field select,
.dep-field input{
  width:100%;
  padding:10px;
  border-radius:12px;
  border:1px solid #cbd5f5;
  margin-top:6px;
}

.wallet-row{
  display:flex;
  gap:8px;
}

.wallet-row input{
  flex:1;
}

.dep-actions{
  display:flex;
  gap:10px;
  margin-top:14px;
}

.confirm-btn{
  flex:1;
  background:linear-gradient(135deg,#ef4444,#f97316);
  border:none;
  color:#fff;
  padding:12px;
  border-radius:14px;
  font-weight:800;
}

.cancel-btn{
  flex:1;
  background:#fff;
  border:2px solid #64748b;
  padding:12px;
  border-radius:14px;
  font-weight:800;
}
</style>
</head>

<body>
<div class="container">

<div class="header">‚ö° PowerMax Dashboard ‚ö°</div>

<div class="user-box">
  <div><b>User ID:</b> <span id="userId">Loading...</span></div>
  <div><b>Balance:</b> <span id="userBalance">0</span> PTS</div>
  <div id="useremail">Loading...</div>
  <div><b>Referred By:</b> <span id="referredBy">None</span></div>
</div>

<!-- ALL PTS PLANTS -->
<div class="plan p50"><div>50 PTS Plant <small>Commission 40%</small></div><button class="btn-active" onclick="activatePlan('50 PTS',40,this)">Activate</button></div>
<div class="plan p100"><div>100 PTS Plant <small>Commission 45%</small></div><button class="btn-active" onclick="activatePlan('100 PTS',45,this)">Activate</button></div>
<div class="plan p300"><div>300 PTS Plant <small>Commission 50%</small></div><button class="btn-active" onclick="activatePlan('300 PTS',50,this)">Activate</button></div>
<div class="plan p500"><div>500 PTS Plant <small>Commission 60%</small></div><button class="btn-active" onclick="activatePlan('500 PTS',60,this)">Activate</button></div>
<div class="plan p1000"><div>1000 PTS Plant <small>Commission 60%</small></div><button class="btn-active" onclick="activatePlan('1000 PTS',60,this)">Activate</button></div>
<div class="plan p2000"><div>2000 PTS Plant <small>Commission 60%</small></div><button class="btn-active" onclick="activatePlan('2000 PTS',60,this)">Activate</button></div>
<div class="plan p3000"><div>3000 PTS Plant <small>Commission 60%</small></div><button class="btn-active" onclick="activatePlan('3000 PTS',60,this)">Activate</button></div>
<div class="plan p5000"><div>5000 PTS Plant <small>Commission 60%</small></div><button class="btn-active" onclick="activatePlan('5000 PTS',60,this)">Activate</button></div>

<div class="active-box" id="activeBox"></div>

<div class="actions">
  <button class="refer" onclick="openRefer()">Refer & Earn</button>
  <button class="deposit" id="openDeposit">Deposit</button>
  <button class="withdraw" onclick="openWithdraw()">Withdraw</button>
  <button class="support" onclick="openWhatsAppSupport()">
  WhatsApp Support
</button>
</div>

<button class="logout" id="openHistory">History</button>
<button class="logout" onclick="logout()">Logout</button>
<!-- ===== REFERRAL POPUP ===== -->
<div id="referralModal" class="ref-modal">
  <div class="ref-box">

    <h3 class="ref-title">üë• Referral Team & Commission</h3>
    <p class="ref-sub">Share this link to grow your team.</p>

    <label class="ref-label">Your Referral Link</label>
    <div class="ref-link">
      <input id="refLinkInput" type="text" value="REF_LINK_HERE" readonly>
      <button class="copy-btn" id="copyReferral">Copy</button>
    </div>

    <h4 class="level l1">Level 1 Team</h4>
    <div class="level-box" id="directCommissionBox">
  No direct commissions yet.
</div>

    <h4 class="level l2">Level 2 Team (3%)</h4>
    <div class="level-box" id="indirectCommissionBox">No members yet.</div>

    <button id="closeReferral" class="close-ref">Close</button>

  </div>
</div>
<!-- ===== HISTORY POPUP ===== -->
<div id="historyPopup" class="popup">
  <div class="history-box">

    <h3>üìú Transaction History</h3>

    <div class="history-item">
      <b>Deposit:</b> 500 PTS<br>
      <span class="history-status-approved">Approved</span><br>
      <small>02 Jan 2026, 04:20 PM</small>
    </div>

    <div class="history-item">
      <b>Withdraw:</b> 300 PTS<br>
      <span class="history-status-pending">Pending</span><br>
      <small>01 Jan 2026, 01:10 PM</small>
    </div>

    <div class="history-item">
      <b>Withdraw:</b> 200 PTS<br>
      <span class="history-status-cancel">Canceled</span><br>
      <small>31 Dec 2025, 09:45 PM</small>
    </div>

    <button class="close-btn" onclick="document.getElementById('historyPopup').style.display='none'">
      Close
    </button>

  </div>
</div>
</div>
<!-- ===== WITHDRAW POPUP ===== -->
<div id="withdrawModal" class="dep-modal">
  <div class="dep-box">

    <h3 class="dep-title">üí∏ Withdraw PTS</h3>

    <div class="dep-field">
      <small style="color:#dc2626;font-weight:700">
        Minimum withdrawal: 10 PTS
      </small>
    </div>

    <div class="dep-field">
      <label>Amount (Min 10 PTS)</label>
      <input id="withdrawAmount" type="number" min="10" placeholder="Enter amount">
    </div>

    <div class="dep-field">
      <label>Withdraw Method</label>
      <select id="withdrawMethod">
        <option value="jazz">JazzCash</option>
        <option value="easy">EasyPaisa</option>
      </select>
    </div>

    <div class="dep-field">
      <label>Wallet Owner Name</label>
      <input id="withdrawName" type="text" placeholder="Enter your registered name">
    </div>

    <div class="dep-field">
      <label>Account Number (JazzCash / EasyPaisa)</label>
      <input id="withdrawAccount" type="text" maxlength="11" placeholder="Enter 11 digit account number">
    </div>

    <div class="dep-actions">
      <button class="confirm-btn">Request Withdraw</button>
      <button id="closeWithdraw" class="cancel-btn">Cancel</button>
    </div>

  </div>
</div>
<!-- ===== DEPOSIT POPUP ===== -->
<div id="depositModal" class="dep-modal">
  <div class="dep-box">

    <h3 class="dep-title">üí∞ Deposit Chips</h3>

    <div class="dep-field">
      <label>Amount (PTS)</label>
      <select>
        <option>50 PTS</option>
        <option>100 PTS</option>
        <option>300 PTS</option>
        <option>500 PTS</option>
        <option>1000 PTS</option>
        <option>2000 PTS</option>
        <option>3000 PTS</option>
        <option>5000 PTS</option>
      </select>
    </div>

    <div class="dep-field">
      <label>Wallet (Send To)</label>
      <select id="walletSelect">
        <option value="jazz">JazzCash</option>
        <option value="easy">Easypaisa</option>
      </select>
    </div>

    <div class="dep-field">
      <label>Wallet Number (Send To)</label>
      <div class="wallet-row">
        <input id="walletNumber" type="text" value="03090447488" readonly>
        <button class="copy-btn" onclick="copyDepositNumber()">Copy</button>
      </div>
    </div>

    <div class="dep-field">
      <label>Wallet Owner Name (Sent From)</label>
      <input type="text" placeholder="Enter wallet owner name">
    </div>

    <div class="dep-field">
      <label>Your Wallet Number (Sent From)</label>
      <input type="text" placeholder="Enter your wallet number">
    </div>

    <div class="dep-actions">
      <button class="confirm-btn">Confirm Request</button>
      <button id="closeDeposit" class="cancel-btn">Cancel</button>
    </div>

  </div>
</div>
<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getAuth,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

import {
  getFirestore,
  doc,
  setDoc,
  getDoc,
  updateDoc,
  increment,
  collection,
  query,
  where,
  getDocs,
  addDoc   // üëà ADD THIS
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
     apiKey: "AIzaSyCzHxyLgn9ZKRwD1X0RuUSq3od6MWizieg",
  authDomain: "powermax-fe149.firebaseapp.com",
  projectId: "powermax-fe149"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
// üîß LOAD GLOBAL SETTINGS
async function loadGlobalSettings() {
  const ref = doc(db, "settings", "global");
  const snap = await getDoc(ref);

  if (!snap.exists()) {
    console.error("‚ùå Global settings not found");
    return null;
  }

  return snap.data();
}
const activeBox = document.getElementById("activeBox");
// üîí ADMIN CHECK FUNCTION
async function isAdmin(uid) {
  const adminRef = doc(db, "admins", uid);
  const adminSnap = await getDoc(adminRef);

  if (!adminSnap.exists()) {
    return false;
  }

  return adminSnap.data().role === "admin";
}
// üîπ Save user in Firestore
function generateRefCode() {
  return "PMX" + Math.random().toString(36).substring(2,8).toUpperCase();
}
function getReferralCodeFromURL() {
  const params = new URLSearchParams(window.location.search);
  return params.get("ref"); // null if not exists
}

async function saveUser(u) {
  const ref = doc(db, "users", u.uid);
  const snap = await getDoc(ref);

  if (!snap.exists()) {
    const referredBy = getReferralCodeFromURL();

await setDoc(ref, {
  email: u.email,
  balance: 0,
  refCode: generateRefCode(),
  referredBy: referredBy || null,
  createdAt: new Date().toISOString()
});
  }
}

/* üîê USER CHECK */
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    location.href = "index.html";
    return;
  }

  // üîπ email show
  document.getElementById("useremail").innerText = user.email;

  // üîπ pehle ensure user saved ho
  await saveUser(user);
  // üîê ADMIN CHECK (STEP 2)
const admin = await isAdmin(user.uid);

if (admin) {
  console.log("‚úÖ Admin logged in:", user.email);
  // future: admin panel access
} else {
  console.log("üë§ Normal user:", user.email);
}
// üîí Global admin flag
window.IS_ADMIN = admin;

  // üîπ ab Firestore se real data load
  const userRef = doc(db, "users", user.uid);
  const snap = await getDoc(userRef);

  if (snap.exists()) {
    document.getElementById("userBalance").innerText =
      snap.data().balance ?? 0;

    document.getElementById("userId").innerText =
      snap.data().refCode ?? "NO REF";
      document.getElementById("referredBy").innerText =
  snap.data().referredBy ?? "Direct / No Referrer";
      const refCode = snap.data().refCode;
const baseUrl = window.location.origin + window.location.pathname.replace(/\/[^\/]*$/, "");
const referralLink = `${baseUrl}/index.html?ref=${refCode}`;
document.getElementById("refLinkInput").value = referralLink;
      const plantRef = doc(db, "users", user.uid, "plants", "active");
  const plantSnap = await getDoc(plantRef);

  if (plantSnap.exists()) {
    const p = plantSnap.data();

    activeBox.style.display = "block";
    activeBox.innerHTML = `
      <h3>Active PTS Plant Details</h3>
      <b>Plan:</b> ${p.planName}<br>
      <b>Commission:</b> ${p.commission}%<br><br>
      <b>Activated:</b><br>${new Date(p.activatedAt).toLocaleString()}<br><br>
      <b>Expiry:</b><br>${new Date(p.expiryAt).toLocaleString()}
    `;
    // üîí Keep active plan button GREEN permanently until expiry
    document.querySelectorAll(".plan").forEach(planDiv => {
      if (planDiv.innerText.includes(p.planName)) {
        const btn = planDiv.querySelector("button");
        btn.classList.remove("btn-active");
        btn.classList.add("btn-on");
      }
    });
  }
  }
});



window.openWhatsAppSupport = () => {
  const user = auth.currentUser;

  if (!user) {
    alert("User not logged in");
    return;
  }

  const name = user.email; 
const uid = document.getElementById("userId").innerText;
  const balance = document.getElementById("userBalance").innerText;

  const message = `Hello PowerMax Support, I need assistance.

*Account Details:*
Name: ${name}
UID: ${uid}
Balance: ${balance} pts

My Query is: `;

  const phone = "923008775258"; // ÿßŸæŸÜÿß WhatsApp number
  const url = "https://wa.me/" + phone + "?text=" + encodeURIComponent(message);

  window.open(url, "_blank");
};
document.getElementById("openHistory").onclick = () => {
  document.getElementById("historyPopup").style.display = "flex";
};
/* OPEN DEPOSIT */
document.getElementById("openDeposit").onclick = function () {
  document.getElementById("depositModal").style.display = "flex";
};

/* CLOSE DEPOSIT */
document.getElementById("closeDeposit").onclick = function () {
  document.getElementById("depositModal").style.display = "none";
};

/* OPEN WITHDRAW */
window.openWithdraw = () => {
  document.getElementById("withdrawModal").style.display = "flex";
};

/* CLOSE WITHDRAW */
document.getElementById("closeWithdraw").onclick = () => {
  document.getElementById("withdrawModal").style.display = "none";
};

/* AUTO CHANGE NUMBER */
document.getElementById("walletSelect").onchange = function () {
  const num = document.getElementById("walletNumber");
  if(this.value === "jazz"){
    num.value = "03090447488";
  }else{
    num.value = "03008775258";
  }
};

/* COPY NUMBER */
window.copyDepositNumber = function () {
  const input = document.getElementById("walletNumber");
  input.select();
  input.setSelectionRange(0, 99999);
  navigator.clipboard.writeText(input.value);
};
window.activatePlan = async (planName, commission, btn) => {
  const user = auth.currentUser;
  if (!user) {
    alert("User not logged in");
    return;
  }

  const plantRef = doc(db, "users", user.uid, "plants", "active");

  // üîí Duplicate check
  const existingPlantSnap = await getDoc(plantRef);
  if (existingPlantSnap.exists()) {
    const data = existingPlantSnap.data();
    if (new Date(data.expiryAt) > new Date()) {
      alert("Plant already active. Wait until expiry.");
      return;
    }
  }

  const start = new Date();
  const expiry = new Date();
  // üîß get expiry days from admin settings
const settings = await loadGlobalSettings();
const days = settings.planExpiryDays || 30;

expiry.setDate(start.getDate() + days);
  // üîí LOW BALANCE CHECK
const plantPts = parseInt(planName.split(" ")[0]);

const balanceSnap = await getDoc(doc(db, "users", user.uid));
const balance = balanceSnap.data().balance || 0;

if (balance < plantPts) {
  alert("Low Balance");
  return;
}
// üí∏ CUT USER BALANCE
await updateDoc(doc(db, "users", user.uid), {
  balance: increment(-plantPts)
});

  // ‚úÖ Save plant
  await setDoc(plantRef, {
    planName,
    commission,
    activatedAt: start.toISOString(),
    expiryAt: expiry.toISOString()
  });

  // üî• COMMISSION LOGIC (FINAL ‚Äî AS PER RULES)


/* =========================
   1Ô∏è‚É£ DIRECT COMMISSION (30%)
   ONLY FOR THE USER
========================= */

const DIRECT_COMMISSION = 30;
const selfCommission = plantPts * (DIRECT_COMMISSION / 100);

await updateDoc(doc(db, "users", user.uid), {
  balance: increment(selfCommission)
});
// üîπ LEVEL 1 ‚Äì DIRECT COMMISSION LOG
await addDoc(
  collection(db, "users", user.uid, "directCommissions"),
  {
    fromUser: user.uid,
    amount: selfCommission,
    plan: planName,
    createdAt: new Date().toISOString()
  }
);

/* =========================
   2Ô∏è‚É£ REFERRAL COMMISSION
   BASED ON REFERRER PLAN
========================= */

const userRef = doc(db, "users", user.uid);
const userSnap = await getDoc(userRef);

if (userSnap.exists()) {
  const referredBy = userSnap.data().referredBy;

  if (referredBy) {
    const q = query(
      collection(db, "users"),
      where("refCode", "==", referredBy)
    );

    const qsnap = await getDocs(q);

    for (const refDoc of qsnap.docs) {
      // referrer commission = based on HIS active plan
      const refCommission = plantPts * (commission / 100);

      await updateDoc(doc(db, "users", refDoc.id), {
        balance: increment(refCommission)
      });
      // üìù LOG INDIRECT COMMISSION (for Refer & Earn UI)
await addDoc(
  collection(db, "users", refDoc.id, "indirectCommissions"),
  {
    fromUser: user.uid,
    amount: refCommission,
    plan: planName,
    createdAt: new Date().toISOString()
  }
);
    }
  }
}

  // üîÑ UI update
  document.querySelectorAll(".plan button").forEach(b => {
    b.className = "btn-active";
    b.innerText = "Activate";
  });

  btn.className = "btn-on";
  btn.innerText = "Activated";

  activeBox.style.display = "block";
  activeBox.innerHTML = `
    <h3>Active PTS Plant Details</h3>
    <b>Plan:</b> ${planName}<br>
    <b>Commission:</b> ${commission}%<br><br>
    <b>Activated:</b><br>${start.toLocaleString()}<br><br>
        <b>Expiry:</b><br>${expiry.toLocaleString()}
  `;
};
window.logout = async function () {
  try {
    await signOut(auth);
    location.href = "index.html";
  } catch (e) {
    alert("Logout failed");
    console.error(e);
  }
};

</script>
<script>
/* OPEN REFER POPUP */
window.openRefer = () => {
  document.getElementById("referralModal").style.display = "flex";
  (async () => {
  const user = auth.currentUser;
  if (!user) return;

  /* ======================
     DIRECT COMMISSIONS
  ====================== */
  const directBox = document.getElementById("directCommissionBox");
  directBox.innerHTML = "Loading...";

  const directSnap = await getDocs(
    collection(db, "users", user.uid, "directCommissions")
  );

  if (directSnap.empty) {
    directBox.innerHTML = "No direct commissions yet.";
  } else {
    directBox.innerHTML = "";
    directSnap.forEach(d => {
      const data = d.data();
      directBox.innerHTML += `
        <div class="history-item">
          <b>${data.amount} PTS</b><br>
          <small>${data.plan}</small><br>
          <small>${new Date(data.createdAt).toLocaleString()}</small>
        </div>
      `;
    });
  }

  /* ======================
     INDIRECT COMMISSIONS
  ====================== */
  const indirectBox = document.querySelector(
  "#directCommissionBox"
).parentElement.querySelectorAll(".level-box")[1];
  indirectBox.innerHTML = "Loading...";

  const indirectSnap = await getDocs(
    collection(db, "users", user.uid, "indirectCommissions")
  );

  if (indirectSnap.empty) {
    indirectBox.innerHTML = "No referral earnings yet.";
  } else {
    indirectBox.innerHTML = "";
    indirectSnap.forEach(d => {
      const data = d.data();
      indirectBox.innerHTML += `
        <div class="history-item">
          <b>${data.amount} PTS</b><br>
          <small>From User: ${data.fromUser}</small><br>
          <small>${data.plan}</small><br>
          <small>${new Date(data.createdAt).toLocaleString()}</small>
        </div>
      `;
    });
  }
})();
};

/* CLOSE REFER */
document.getElementById("closeReferral").onclick = () => {
  document.getElementById("referralModal").style.display = "none";
};

/* COPY REF LINK */
document.getElementById("copyReferral").onclick = function () {
  const input = document.getElementById("refLinkInput");
  navigator.clipboard.writeText(input.value);
  this.innerText = "Copied ‚úì";
  setTimeout(() => this.innerText = "Copy", 1000);
};
</script>

</body>
  </html>
    
