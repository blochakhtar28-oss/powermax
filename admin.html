<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>PowerMax Admin Panel</title>
  <style>
    body { font-family: Arial; background:#111; color:#fff; padding:20px }
    button { padding:6px 12px; margin:4px; cursor:pointer }
    .box { border:1px solid #333; padding:10px; margin-bottom:10px }
  </style>
</head>
<body>

<h2>üîê Admin Panel</h2>
<button onclick="login()">Sign in with Google</button>
<button onclick="logout()">Logout</button>

<hr>

<h3>üí∞ Deposit Requests</h3>
<div id="depositList">Loading...</div>

<hr>

<h3>üèß Withdraw Requests</h3>
<div id="withdrawList">Loading...</div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, getDocs, doc,
  getDoc, updateDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import {
  getAuth, GoogleAuthProvider,
  signInWithPopup, signOut
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

let currentAdmin = null;

/* üîê LOGIN */
window.login = async ()=>{
  const res = await signInWithPopup(auth, provider);
  const user = res.user;

  const snap = await getDoc(doc(db,"admins",user.uid));
  if(!snap.exists()){
    alert("Not admin");
    await signOut(auth);
    return;
  }

  currentAdmin = user;
  loadDeposits();
  loadWithdraws();
};

/* üö™ LOGOUT */
window.logout = async ()=>{
  await signOut(auth);
  location.reload();
};

/* üí∞ LOAD DEPOSITS */
async function loadDeposits(){
  const box = document.getElementById("depositList");
  box.innerHTML = "Loading...";

  const snap = await getDocs(collection(db,"depositRequests"));
  box.innerHTML = "";

  snap.forEach(d=>{
    const w = d.data();
    if(w.status !== "pending") return;

    box.innerHTML += `
      <div class="box">
        <b>${w.email}</b><br>
        Amount: ${w.amount}<br>
        TRX: ${w.trx}<br>
        <button onclick="approveDeposit('${d.id}','${w.uid}',${w.amount})">Approve</button>
        <button onclick="rejectDeposit('${d.id}')">Reject</button>
      </div>
    `;
  });
}
  window.approveDeposit = async (requestId, userId, amount)=>{
  if(!confirm("Approve this deposit?")) return;

  try{
    await runTransaction(db, async(transaction)=>{

      const userRef = doc(db,"users",userId);
      const depositRef = doc(db,"depositRequests",requestId);

      const userSnap = await transaction.get(userRef);
      const depositSnap = await transaction.get(depositRef);

      if(!userSnap.exists()) throw "User not found";
      if(!depositSnap.exists()) throw "Deposit not found";

      if(depositSnap.data().status !== "pending"){
        throw "Already processed";
      }

      const oldBalance = userSnap.data().balance || 0;

      // ‚ûï Add balance
      transaction.update(userRef,{
        balance: oldBalance + amount
      });

      // ‚úÖ Approve deposit
      transaction.update(depositRef,{
        status: "approved",
        approvedAt: new Date()
      });
    });

    alert("Deposit approved successfully");
    loadDeposits();

  }catch(err){
    alert("Error: " + err);
  }
};
</script>

</body>
 </html>
